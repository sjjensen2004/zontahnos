version: "3.7"

services:
    # proxy:
    #     build: nginx
    #     ports:
    #       - 80:80
    #       - 443:443
    #     depends_on:
    #       - api

    api:
        build: zontahnos
        environment:
          - PORT=8080
        ports:
          - 8000:8000
        tty: true
        stdin_open: true
        command: uvicorn main:app --reload --host 0.0.0.0
        volumes:
          - ./zontahnos/app/app:/app/app

    influxdb2:
      image: influxdb:2
      ports:
        - 8086:8086
      environment:
        DOCKER_INFLUXDB_INIT_MODE: setup
        DOCKER_INFLUXDB_INIT_USERNAME_FILE: /run/secrets/influxdb2-admin-username
        DOCKER_INFLUXDB_INIT_PASSWORD_FILE: /run/secrets/influxdb2-admin-password
        DOCKER_INFLUXDB_INIT_ADMIN_TOKEN_FILE: /run/secrets/influxdb2-admin-token
        DOCKER_INFLUXDB_INIT_ORG: netsmart
        DOCKER_INFLUXDB_INIT_BUCKET: network_monitoring
      secrets:
        - influxdb2-admin-username
        - influxdb2-admin-password
        - influxdb2-admin-token
      volumes:
        - type: volume
          source: influxdb2-data
          target: /var/lib/influxdb2
        - type: volume
          source: influxdb2-config
          target: /etc/influxdb2
    grafana:
      image: grafana/grafana:latest
      container_name: grafana
      ports:
        - "3000:3000"  # Grafana UI
      environment:
        - GF_SECURITY_ADMIN_USER=admin
        - GF_SECURITY_ADMIN_PASSWORD=admin123
      volumes:
        - grafana_data:/var/lib/grafana
      depends_on:
        - influxdb2
      restart: unless-stopped

secrets:
  influxdb2-admin-username:
    file: .env/influxdb2-admin-username
  influxdb2-admin-password:
    file: .env/influxdb2-admin-password
  influxdb2-admin-token:
    file: .env/influxdb2-admin-token

volumes:
  influxdb2-data:
  influxdb2-config:
  grafana_data:
